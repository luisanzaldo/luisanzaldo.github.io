---
import Title from "@components/global/Title.astro";

import { getLangFromUrl, useTranslations, useTranslatedPath } from "@i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);
---

<section class="isolate px-6 py-24 sm:py-32 lg:px-8">
	<div class="mx-auto">
		<Title class="pb-10 pt-20 uppercase" title={t("contact.title")} subtitle={t("contact.subtitle")} />
		
		<!-- Chatbot Interface -->
		<div class="mx-auto max-w-2xl pt-12 lg:pt-20">
			<div class="bg-white/50 backdrop-blur-sm rounded-2xl shadow-xl overflow-hidden border border-white/20">
				<!-- Chat History -->
				<div id="chat-history" class="h-[400px] overflow-y-auto p-6 space-y-4 bg-slate-50/50">
					<div class="flex flex-col gap-2 w-full">
						<div class="self-start bg-slate-200 rounded-lg rounded-tl-none px-4 py-2 max-w-[85%] text-slate-800 shadow-sm prose prose-slate prose-sm max-w-none break-words overflow-x-auto">
							{lang === 'en' 
								? (
									<p>¡Hola! Si deseas agendar una videollamada con gusto puedo ayudarte. Solo compárteme tu nombre, correo electrónico, el día y hora en que deseas platicar con nosotros y el tema que te gustaría abordar.<br /><br />También puedo brindarte información sobre los servicios que <strong>metarrelato</strong> ofrece.</p>
								)
								: (
									<p>Hello! If you'd like to schedule a video call, I'd be happy to help. Just share your name, email, the day and time you'd like to talk with us, and the topic you'd like to discuss.<br /><br />I can also provide information about the services <strong>metarrelato</strong> offers.</p>
								)}
						</div>
					</div>
				</div>

				<!-- Input Area -->
				<div class="p-4 bg-white border-t border-slate-100">
					<div class="flex gap-4 items-end">
						<textarea
							id="chat-input"
							class="flex-1 bg-slate-100 border-0 rounded-xl px-4 py-3 text-slate-800 focus:ring-2 focus:ring-purple-500 outline-none transition-all placeholder:text-slate-400 resize-none max-h-32 min-h-[48px]"
							placeholder={t("contact.message")}
							rows="1"
						></textarea>
						<button 
							id="send-button"
							class="bg-[#F06071] text-white p-3 rounded-xl hover:bg-[#F06071]/80 transition-colors flex items-center justify-center aspect-square shadow-lg hover:shadow-xl transform hover:scale-105 shrink-0"
							aria-label={t("contact.send")}
						>
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
								<path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
							</svg>
						</button>
					</div>
					<div class="text-center mt-3">
						 <p class="text-xs text-slate-400">
							{t("contact.agree")} <a href="/privacy" class="font-semibold text-slate-600 hover:text-purple-600 transition-colors">privacy policy</a>.
						</p>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<script>
	import { marked } from 'marked';

	const chatInput = document.getElementById('chat-input') as HTMLTextAreaElement;
	const sendButton = document.getElementById('send-button');
	const chatHistory = document.getElementById('chat-history');
	let isSending = false;

	// Generate or retrieve a session ID for n8n
	let sessionId = sessionStorage.getItem('chat_session_id');
	if (!sessionId) {
		sessionId = Math.random().toString(36).substring(7) + Date.now();
		sessionStorage.setItem('chat_session_id', sessionId);
	}

	function addMessage(text: string, isUser: boolean) {
		if (!chatHistory) return;
		
		const wrapper = document.createElement('div');
		wrapper.className = `flex flex-col gap-2 w-full ${isUser ? 'items-end' : 'items-start'}`;
		
		const message = document.createElement('div');
		// Apply prose class for bot messages to render markdown nicely
		const proseClasses = isUser ? '' : 'prose prose-slate prose-sm max-w-none prose-p:leading-relaxed prose-pre:bg-slate-800 prose-pre:text-white break-words overflow-x-auto';
		message.className = `px-4 py-2 max-w-[85%] rounded-lg ${isUser ? 'bg-zinc-900 text-white rounded-tr-none shadow-md' : 'bg-slate-200 text-slate-800 rounded-tl-none shadow-sm'} ${proseClasses}`;
		
		if (isUser) {
			message.textContent = text;
		} else {
			// Parse markdown for bot messages
			message.innerHTML = marked.parse(text) as string;
		}
		
		wrapper.appendChild(message);
		chatHistory.appendChild(wrapper);
		chatHistory.scrollTop = chatHistory.scrollHeight;
		return wrapper;
	}

	async function handleSend() {
		if (!chatInput || !chatInput.value.trim() || isSending) return;
		
		const text = chatInput.value;
		addMessage(text, true);
		chatInput.value = '';
		chatInput.style.height = 'auto'; // Reset height after send
		
		isSending = true;
		if (sendButton) {
			sendButton.setAttribute('disabled', 'true');
			sendButton.style.opacity = '0.5';
		}
		
		const typingIndicator = addMessage('...', false);
		
		try {
			const response = await fetch('https://n8n-5q3b.onrender.com/webhook/1cdb800c-94c3-4d7c-a219-a69dc8e0ebcd/chat', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({ 
					chatInput: text,
					sessionId: sessionId
				}),
			});

			if (typingIndicator) typingIndicator.remove();

			if (!response.ok) throw new Error('Failed to get response');

			const data = await response.json();
			// Handle different possible n8n response structures
			const botMessage = typeof data === 'string' ? data : (data.output || data.message || data.response || "Lo siento, no pude procesar la respuesta.");
			addMessage(botMessage, false);
		} catch (error) {
			console.error('Chat error:', error);
			if (typingIndicator) typingIndicator.remove();
			addMessage("Lo siento, tuve un problema al conectarme con el asistente. Por favor, intenta de nuevo más tarde.", false);
		} finally {
			isSending = false;
			if (sendButton) {
				sendButton.removeAttribute('disabled');
				sendButton.style.opacity = '1';
			}
		}
	}

	sendButton?.addEventListener('click', handleSend);
	
	chatInput?.addEventListener('input', () => {
		chatInput.style.height = 'auto';
		chatInput.style.height = `${chatInput.scrollHeight}px`;
	});

	chatInput?.addEventListener('keydown', (e) => {
		if (e.key === 'Enter' && !e.shiftKey) {
			e.preventDefault();
			handleSend();
		}
	});
</script>

<style>
</style>
