---
interface Props {
	src: string;
	class?: string;
	id?: string;
	autoplay?: boolean;
	loop?: boolean;
}

const {
	src,
	class: className = "",
	id = `dotlottie-${Math.random().toString(36).substring(2, 9)}`,
	autoplay = true,
	loop = true,
} = Astro.props;
---

<dotlottie-player
	id={id}
	data-src={src}
	data-autoplay={autoplay.toString()}
	data-loop={loop.toString()}
	class:list={["relative flex items-center justify-center", className]}
>
</dotlottie-player>

<script>
	import { DotLottie } from "@lottiefiles/dotlottie-web";

	class DotLottiePlayerElement extends HTMLElement {
		private dotLottieInstance: DotLottie | null = null;
		private canvas: HTMLCanvasElement | null = null;

		constructor() {
			super();
		}

		connectedCallback() {
			// Allow a small tick so dimensions are resolved, preventing zero-width canvas
			setTimeout(() => {
				const src = this.dataset.src;
				const autoplay = this.dataset.autoplay === "true";
				const loop = this.dataset.loop === "true";

				if (!src) return;

				this.canvas = document.createElement("canvas");
				this.canvas.style.width = "100%";
				this.canvas.style.height = "100%";
				// Set initial internal resolution to match container (helps prevent blur)
				this.canvas.width = this.clientWidth || 300;
				this.canvas.height = this.clientHeight || 300;
				
				this.appendChild(this.canvas);

				this.dotLottieInstance = new DotLottie({
					canvas: this.canvas,
					src,
					autoplay,
					loop,
				});
				
				// Handle resize
				const resizeObserver = new ResizeObserver(() => {
					if (this.dotLottieInstance && this.canvas) {
						this.dotLottieInstance.resize();
					}
				});
				resizeObserver.observe(this);
			}, 100);
		}

		disconnectedCallback() {
			if (this.dotLottieInstance) {
				this.dotLottieInstance.destroy();
			}
		}
	}

	if (!customElements.get("dotlottie-player")) {
		customElements.define("dotlottie-player", DotLottiePlayerElement);
	}
</script>
