---
interface Props {
	src: string;
	class?: string;
	id?: string;
	autoplay?: boolean;
	loop?: boolean;
}

const {
	src,
	class: className = "",
	id = `dotlottie-${Math.random().toString(36).substring(2, 9)}`,
	autoplay = true,
	loop = true,
} = Astro.props;
---

<dotlottie-player
	id={id}
	data-src={src}
	data-autoplay={autoplay.toString()}
	data-loop={loop.toString()}
	class:list={["relative flex items-center justify-center", className]}
>
</dotlottie-player>

<script>

	class DotLottiePlayerElement extends HTMLElement {
		private dotLottieInstance: any = null;
		private canvas: HTMLCanvasElement | null = null;

		constructor() {
			super();
		}

		async connectedCallback() {
			const src = this.dataset.src;
			const autoplay = this.dataset.autoplay === "true";
			const loop = this.dataset.loop === "true";

			if (!src) return;

			this.canvas = document.createElement("canvas");
			this.canvas.style.width = "100%";
			this.canvas.style.height = "100%";
			
			const dpr = window.devicePixelRatio || 1;
			this.canvas.width = (this.clientWidth || 300) * dpr;
			this.canvas.height = (this.clientHeight || 300) * dpr;
			
			this.appendChild(this.canvas);

			// Dynamically load to drastically reduce the main JS bundle weight
			const { DotLottie } = await import("@lottiefiles/dotlottie-web");

			this.dotLottieInstance = new DotLottie({
				canvas: this.canvas,
				src,
				autoplay,
				loop,
			});
			
			const resizeObserver = new ResizeObserver(() => {
				if (this.dotLottieInstance && this.canvas) {
					const currentDpr = window.devicePixelRatio || 1;
					this.canvas.width = (this.clientWidth || 300) * currentDpr;
					this.canvas.height = (this.clientHeight || 300) * currentDpr;
					this.dotLottieInstance.resize();
				}
			});
			resizeObserver.observe(this);
		}

		disconnectedCallback() {
			if (this.dotLottieInstance) {
				this.dotLottieInstance.destroy();
			}
		}
	}

	if (!customElements.get("dotlottie-player")) {
		customElements.define("dotlottie-player", DotLottiePlayerElement);
	}
</script>
