---
import BaseLayout from "../layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import heroImageDark from "../images/angel-anzaldo.jpg";
import heroImageLight from "../images/angel-anzaldo.jpg";
import Social from "../components/Social.astro";
import { Icon } from "astro-icon/components";
import FeaturedArticles from "../components/articles/FeaturedArticles.astro";
import Projects from "../components/Projects.astro";
import NewsletterForm from "../components/NewsletterForm.astro";
---

<BaseLayout>
	<!-- Hero section -->
	<div class="mx-auto lg:max-w-4xl mt-40 mb-20 reveal-on-scroll">
		<div class="flex flex-col lg:flex-row lg:items-center lg:space-x-16">
			<div class="flex-1">
				<h1
					class="text-3xl sm:text-5xl font-bold tracking-tight text-balance typewriter"
					data-speed="33"
				>
					Automatización de procesos con IA para pymes y proyectos ciudadanos
				</h1>
				<div class="mt-8 leading-8">
					<p class="typewriter" data-speed="13" data-delay="2000">
						¿Eres una pequeña o mediana empresa y deseas aumentar tu
						productividad y eficientar tus procesos por medio de
						Inteligencia Artificial? Te ayudo a implementar
						las herramientas que necesitas para lograr tus objetivos.
						
						Además, al contratar mis servicios impulsas el desarrollo de agentes
						de IA con fines sociales y altruistas.

					</p>
				</div>
			</div>

			<div class="order-first lg:order-last flex-shrink-0 mb-8">

				<Image
					src={heroImageLight}
					alt="Code. Blood. Mild workplace horror."
					class="block dark:hidden  rounded-full  size-20 lg:size-[350px] object-cover ring-1 ring-slate-400/30 shadow scale-on-scroll"
				/>
				<Image
					src={heroImageDark}
					alt="Code. Blood. Mild workplace horror."
					class="hidden dark:block rounded-full size-20 lg:size-[350px] object-cover ring-1 ring-slate-400/30 shadow scale-on-scroll"
				/>
			</div>
		</div>
		<div
			id="hero-footer-seq"
			class="chained-scale sm:flex sm:items-center sm:justify-between space-y-4 sm:space-y-0 my-10"
		>
			<a
				href="mailto:luis.anzaldo@metarrelato.com"
				class="flex items-center space-x-1 hover:text-primary-500"
			>
				<Icon name="heroicons:envelope" class="size-5" />
				<span>luis.anzaldo@metarrelato.com</span>
			</a>
			<div class="flex items-center space-x-4">
				<Social />
			</div>
		</div>

	<!-- Featured articles -->
	<div class="mx-auto lg:max-w-4xl my-16 sm:my-30 chained-scale" id="featured-seq">
		<h2
			class="text-2xl sm:text-4xl font-bold tracking-tight mb-10 sm:mb-20"
		>
			Destacados
		</h2>
		<FeaturedArticles />
	</div>

	<!-- Projects -->
	<div class="my-16 sm:my-30 chained-scale" id="projects-seq">
		<div class="mx-auto lg:max-w-4xl">
			<h2
				class="text-2xl sm:text-4xl font-bold tracking-tight mb-10 sm:mb-20"
			>
				Proyectos
			</h2>
		</div>

		<div class="mx-auto lg:max-w-5xl">
			<Projects />
		</div>
	</div>

</BaseLayout>

<script>
	// Promise-based Typewriter
	const typeWriter = async (element, speed, delay = 0) => {
		const text = element.textContent.replace(/\s+/g, ' ').trim();
		element.setAttribute('aria-label', text);
		element.setAttribute('role', 'text');

		element.innerHTML = text.split('').map(char => {
			return `<span style="opacity: 0; transition: opacity 0.1s">${char}</span>`;
		}).join('');

		element.style.visibility = 'visible';
		const spans = element.querySelectorAll('span');

		// Helper to wait for delay, but break if skipped
		const waitDelay = () => new Promise(resolve => {
			if (delay <= 0) return resolve();
			const start = Date.now();
			const timer = setInterval(() => {
				if (element.dataset.skip === "true" || Date.now() - start >= delay) {
					clearInterval(timer);
					resolve();
				}
			}, 50); // Check every 50ms
		});

		await waitDelay();

		return new Promise((resolve) => {
			// If skipped during delay or before start
			if (element.dataset.skip === "true") {
				spans.forEach(span => span.style.opacity = '1');
				element.dataset.typingDone = "true";
				resolve();
				return;
			}

			let i = 0;
			const timer = setInterval(() => {
				// Check for skip signal during typing
				if (element.dataset.skip === "true") {
					clearInterval(timer);
					spans.forEach(span => span.style.opacity = '1');
					element.dataset.typingDone = "true";
					resolve();
					return;
				}

				if (i < spans.length) {
					spans[i].style.opacity = '1';
					i++;
					if (i === spans.length) {
						clearInterval(timer);
						element.dataset.typingDone = "true";
						resolve();
					}
				}
			}, speed);
		});
	};

	// Disable browser automatic scroll restoration to avoid the "jump"
	if (history.scrollRestoration) {
		history.scrollRestoration = 'manual';
	}

	let isSequenceRunning = false;

	const startAnimationSequence = async () => {
		// Force scroll to top on every visit to home to fix "back" button issues
		window.scrollTo({ top: 0, behavior: 'instant' });

		if (isSequenceRunning) return;
		isSequenceRunning = true;

		const elements = document.querySelectorAll('.typewriter');
		const promises = [];

		// Helper to observe next section
		const observeNext = (id, onVisible) => {
			const el = document.getElementById(id);
			if (!el) return;
			
			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						entry.target.classList.add('is-visible');
						observer.disconnect(); // Stop observing once visible
						if (onVisible) {
							// Wait for this animation to finish before enabling next
							setTimeout(onVisible, 800);
						}
					}
				});
			}, { threshold: 0.1 });
			
			observer.observe(el);
		};

		// Check if we've already shown the intro in this session
		if (sessionStorage.getItem('introShown')) {
			// Skip typewriter animation
			// Make sure typewriter text is visible (it defaults to visible but we avoid the span-splitting)
			elements.forEach(el => {
				el.style.visibility = 'visible';
			});

			// Reveal sections immediately that would normally be chained
			const footer = document.getElementById('hero-footer-seq');
			if (footer) footer.classList.add('is-visible');

			const featured = document.getElementById('featured-seq');
			if (featured) featured.classList.add('is-visible');

			// Enable projects scroll observer immediately
			observeNext('projects-seq');
			
			return;
		}

		// First time visit: Mark as shown
		sessionStorage.setItem('introShown', 'true');

		// Sequential Skip Handler
		const skipHandler = (e) => {
			// Check for Enter key or Click
			// We avoid 'touchstart' to prevent double-firing (ghost clicks) on mobile causing both lines to skip at once.
			if ((e.type === 'keydown' && e.key === 'Enter') || e.type === 'click') {
				// Find the first typewriter that isn't done yet
				const target = Array.from(elements).find(el => el.dataset.typingDone !== "true");
				if (target) {
					target.dataset.skip = "true";
				} else {
					// All done, remove listeners
					document.removeEventListener('keydown', skipHandler);
					document.removeEventListener('click', skipHandler);
				}
			}
		};

		document.addEventListener('keydown', skipHandler);
		document.addEventListener('click', skipHandler);

		elements.forEach(el => {
			if (el.dataset.typingStarted) return;
			el.dataset.typingStarted = "true";
			// Clean up any old state if swapped back
			delete el.dataset.skip;
			delete el.dataset.typingDone;
			
			const speed = parseInt(el.getAttribute('data-speed')) || 50;
			const delay = parseInt(el.getAttribute('data-delay')) || 0;
			
			// Collect promises
			promises.push(typeWriter(el, speed, delay));
		});

		// Hero Sequence: Typewriters -> Hero Footer -> Featured -> Projects
		// 1. Wait for ALL typewriters to finish (Title + Description)
		if (promises.length > 0) {
			await Promise.all(promises);
			
			// Optional: extra buffer delay requested by user
			await new Promise(r => setTimeout(r, 300));

			// 2. Animate Hero Footer (Email & Socials)
			const footer = document.getElementById('hero-footer-seq');
			if (footer) {
				footer.classList.add('is-visible');
				// Wait for footer animation (0.8s)
				await new Promise(r => setTimeout(r, 800));
			}

			// 3. Animate Featured Section (Chain immediately after Footer)
			const featured = document.getElementById('featured-seq');
			if (featured) {
				featured.classList.add('is-visible');
				// Wait for featured animation (0.8s) before unlocking scroll observer for projects
				await new Promise(r => setTimeout(r, 800));
			}

			// 4. Enable Projects Section (Scale on scroll) after Featured is done
			observeNext('projects-seq');
		}
	};
	document.addEventListener('astro:after-swap', () => {
		isSequenceRunning = false;
	});
	document.addEventListener('astro:page-load', startAnimationSequence);
	document.addEventListener('DOMContentLoaded', startAnimationSequence);
</script>
