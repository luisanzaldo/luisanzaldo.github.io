---
import BaseLayout from "../layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import heroImageDark from "../images/angel-anzaldo.jpg";
import heroImageLight from "../images/angel-anzaldo.jpg";
import Social from "../components/Social.astro";
import { Icon } from "astro-icon/components";
import FeaturedArticles from "../components/articles/FeaturedArticles.astro";
import Projects from "../components/Projects.astro";
import NewsletterForm from "../components/NewsletterForm.astro";
---

<BaseLayout>
	<!-- Hero section -->
	<div class="mx-auto lg:max-w-4xl mt-40 mb-20 reveal-on-scroll">
		<div class="flex flex-col lg:flex-row lg:items-center lg:space-x-16">
			<div class="flex-1">
				<h1
					class="text-3xl sm:text-5xl font-bold tracking-tight text-balance typewriter"
					data-speed="33"
				>
					Automatización de procesos con IA para pymes y proyectos ciudadanos
				</h1>
				<div class="mt-8 leading-8">
					<p class="typewriter" data-speed="13" data-delay="2000">
						¿Eres una pequeña o mediana empresa y deseas aumentar tu
						productividad y tener procesos más eficientes por medio de
						automatización con Inteligencia Artificial? Te ayudo a implementar
						las herramientas que necesitas para lograr tus objetivos.
						Además, al contratar mis servicios apoyas el desarrollo de agentes
						de IA con fines sociales y altruistas.

					</p>
				</div>
			</div>

			<div class="order-first lg:order-last flex-shrink-0 mb-8">

				<Image
					src={heroImageLight}
					alt="Code. Blood. Mild workplace horror."
					class="block dark:hidden  rounded-full  size-20 lg:size-[350px] object-cover ring-1 ring-slate-400/30 shadow scale-on-scroll"
				/>
				<Image
					src={heroImageDark}
					alt="Code. Blood. Mild workplace horror."
					class="hidden dark:block rounded-full size-20 lg:size-[350px] object-cover ring-1 ring-slate-400/30 shadow scale-on-scroll"
				/>
			</div>
		</div>
		<div
			id="hero-footer-seq"
			class="chained-scale sm:flex sm:items-center sm:justify-between space-y-4 sm:space-y-0 my-10"
		>
			<a
				href="mailto:luis.anzaldo@metarrelato.com"
				class="flex items-center space-x-1 hover:text-primary-500"
			>
				<Icon name="heroicons:envelope" class="size-5" />
				<span>luis.anzaldo@metarrelato.com</span>
			</a>
			<div class="flex items-center space-x-4">
				<Social />
			</div>
		</div>

	<!-- Featured articles -->
	<div class="mx-auto lg:max-w-4xl my-16 sm:my-30 chained-scale" id="featured-seq">
		<h2
			class="text-2xl sm:text-4xl font-bold tracking-tight mb-10 sm:mb-20"
		>
			Destacados
		</h2>
		<FeaturedArticles />
	</div>

	<!-- Projects -->
	<div class="my-16 sm:my-30 chained-scale" id="projects-seq">
		<div class="mx-auto lg:max-w-4xl">
			<h2
				class="text-2xl sm:text-4xl font-bold tracking-tight mb-10 sm:mb-20"
			>
				Proyectos
			</h2>
		</div>

		<div class="mx-auto lg:max-w-5xl">
			<Projects />
		</div>
	</div>

</BaseLayout>

<script>
	// Promise-based Typewriter
	const typeWriter = (element, speed, delay = 0) => {
		return new Promise((resolve) => {
			const text = element.textContent.replace(/\s+/g, ' ').trim();
			element.setAttribute('aria-label', text);
			element.setAttribute('role', 'text');

			element.innerHTML = text.split('').map(char => {
				return `<span style="opacity: 0; transition: opacity 0.1s">${char}</span>`;
			}).join('');

			element.style.visibility = 'visible';
			
			setTimeout(() => {
				const spans = element.querySelectorAll('span');
				let i = 0;
				const timer = setInterval(() => {
					if (i < spans.length) {
						spans[i].style.opacity = '1';
						i++;
						if (i === spans.length) {
							clearInterval(timer);
							resolve();
						}
					}
				}, speed);
			}, delay);
		});
	};

	let isSequenceRunning = false;

	const startAnimationSequence = async () => {
		if (isSequenceRunning) return;
		isSequenceRunning = true;

		const elements = document.querySelectorAll('.typewriter');
		const promises = [];

		elements.forEach(el => {
			if (el.dataset.typingStarted) return;
			el.dataset.typingStarted = "true";
			
			const speed = parseInt(el.getAttribute('data-speed')) || 50;
			const delay = parseInt(el.getAttribute('data-delay')) || 0;
			
			// Collect promises
			promises.push(typeWriter(el, speed, delay));
		});

		// Helper to observe next section

		const observeNext = (id, onVisible) => {
			const el = document.getElementById(id);
			if (!el) return;
			
			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						entry.target.classList.add('is-visible');
						observer.disconnect(); // Stop observing once visible
						if (onVisible) {
							// Wait for this animation to finish before enabling next
							setTimeout(onVisible, 800);
						}
					}
				});
			}, { threshold: 0.1 });
			
			observer.observe(el);
		};

		// Independent Sequence: Featured -> Projects
		// Start observing Featured immediately so it's not blocked by typewriter
		observeNext('featured-seq', () => {
			observeNext('projects-seq');
		});

		// Hero Sequence: Typewriters -> Hero Footer
		// 1. Wait for ALL typewriters to finish (Title + Description)
		if (promises.length > 0) {
			await Promise.all(promises);
			
			// Optional: extra buffer delay requested by user
			await new Promise(r => setTimeout(r, 300));

			// 2. Animate Hero Footer (Email & Socials)
			const footer = document.getElementById('hero-footer-seq');
			if (footer) {
				footer.classList.add('is-visible');
			}
		}
	};

	document.addEventListener('astro:after-swap', () => {
		isSequenceRunning = false;
	});
	document.addEventListener('astro:page-load', startAnimationSequence);
	document.addEventListener('DOMContentLoaded', startAnimationSequence);
</script>
